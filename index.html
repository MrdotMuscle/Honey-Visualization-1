<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>INFO5100 Project2</title>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <style>

        .state {
          fill: #EAE6E5;
          stroke: none;
        }

        .outline {
          stroke: black;
          stroke-width: 1px;
          fill: none;
        }

        .graticule {
          fill: none;
          stroke: lightgrey;
        }

    </style>
  </head>

  <body>
    <p id="p1">
      <svg id="svg" height="500" width="700">
      </svg>
      <script>
        /*jshint esversion: 8 */
        const svg = d3.select("#svg");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const margin = { top: 20, right: 20, bottom: 20, left:20};
        const mapWidth = width - margin.left - margin.right;
        const mapHeight = height - margin.top - margin.bottom;
        const map = svg.append("g")
                        .attr("transform","translate("+margin.left+","+margin.top+")");



        const requestData = async function (year) {
          const stateID = await d3.tsv("/us-state-names.tsv");
  // console.log(stateID);
          const us = await d3.json("/us.json");
          // console.log(us);
          var states = topojson.feature(us, us.objects.states);
          var stateMesh = topojson.mesh(us, us.objects.states);
          var projection = d3.geoAlbersUsa().fitSize([mapWidth,mapHeight], states);
          var path = d3.geoPath().projection(projection)
// console.log(states)
          map.selectAll("path").data(states.features)
                               .join("path")
                               .attr("note", d=>d.id)
                               .attr("class","state")
                               .attr("d",path)


          map.append("path").datum(stateMesh)
                            .attr("class","outline")
                            .attr("d",path)

// console.log(stateID);
          let counts = {};
          let shortcutToState = {};

          stateID.forEach( d => {
            counts[d.name] = 0;
            shortcutToState[d.code] = d.name;
            shortcutToState[d.id] = d.name;
          });
// console.log(shortcutToState);
          var data = await d3.csv("/honeyproduction.csv");
console.log(data);
          data.forEach(d => {
            if (d.year == year) {
                counts[shortcutToState[d.state]] = Number(d.totalprod);
            }
          })
// console.log(counts);



          let nonZone = d3.values(counts).filter(d => d>0)
          let domainRange = d3.extent(nonZone)
          console.log(domainRange);

          const colorScale = d3.scaleLinear()
                               .domain(domainRange)
                               .range(["#A09DF1","#232159"])///////////////////need to be changed!!!!!!!!!
          map.selectAll(".state").style("fill", d=> {
            let value = counts[ shortcutToState[d.id] ];
            if (value > 0){
              return colorScale(value)
            }
          })
// console.log(d3.extent(d3.values(counts)));

          d3.select("#slider").on("input", function() {
            let sld = d3.select(this);
            num = sld.property("value");

            requestData(num);

          })


          // Following Patr is for mouseover
          let tooltip = map.append("g")
                         .attr("class","tooltip")
                         .attr("visibility","hidden");

          tooltip.append("rect")
                 .attr("fill", "black")
                 .attr("opacity", 0.9)
                 .attr("width",120)
                 .attr("height",45)

         let txt = tooltip.append("text")
                              .attr("fill", "white")
                              .attr("text-anchor","middle")
                              .attr("alignment-baseline","hanging")
                              .attr("x", 120 / 2.0)
                              .attr("y", 8);
        let txt2 = tooltip.append("text")
                             .attr("fill", "white")
                             .attr("text-anchor","middle")
                             .attr("alignment-baseline","hanging")
                             .attr("x", 120 / 2.0)
                             .attr("y", 26);

          d3.selectAll(".state")
            .on("mouseenter", function() {
              tooltip.style("visibility","visible")
              let target = d3.select(this);
              target.attr("stroke", "white")
                   .attr("stroke-width", 3) //////////////// does not work here!!!!!!!!!!!!!!
              txt.text(shortcutToState[target.datum().id]);
              txt2.text(counts[shortcutToState[target.datum().id]]);

              let boundaries = path.bounds(target.datum());
              let x = (boundaries[0][0]+boundaries[1][0])/2.0 - 60;
              let y = boundaries[1][1];



              tooltip.attr("transform","translate("+x+","+y+")");
            })
            .on("mouseout", function() {
                tooltip.style("visibility","hidden")
                txt.text("")
                txt2.text("")
            })




        };
        requestData(1998);
      </script>
      <input type="range" id="slider" min="1998" max="2012" step="1" value="1998" >

    </p>




  </body>
</html>
